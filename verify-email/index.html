<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon1-32.png">
    <link rel="shortcut icon" href="/favicon1.ico">

    <title>Verify Email - Seekive</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-blue: #4C8BF5;
            --primary-dark: #2563EB;
            --accent-emerald: #10B981;
            --teal-accent: #06B6D4;
            --dark-bg: #0F172A;
            --surface: #1E293B;
            --surface-light: #334155;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-radius: 32px;
            padding: 50px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-blue), var(--teal-accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2.5rem;
            color: white;
        }

        .icon.success {
            background: linear-gradient(135deg, var(--accent-emerald), var(--teal-accent));
            animation: scaleIn 0.5s ease;
        }

        .icon.error {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            animation: shake 0.5s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 16px;
            color: var(--primary-blue);
        }

        h1.success {
            color: var(--accent-emerald);
        }

        h1.error {
            color: #EF4444;
        }

        p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .spinner {
            border: 4px solid rgba(76, 139, 245, 0.3);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(76, 139, 245, 0.3);
            margin-top: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(76, 139, 245, 0.4);
        }

        .message-container {
            display: none;
        }

        .message-container.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 40px 24px;
            }

            h1 {
                font-size: 1.75rem;
            }

            p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="message-container show">
            <div class="icon">
                <div class="spinner"></div>
            </div>
            <h1>Verifying Your Email...</h1>
            <p>Please wait while we confirm your email address.</p>
        </div>

        <!-- Success State -->
        <div id="success" class="message-container">
            <div class="icon success">
                <i class="fa-solid fa-check"></i>
            </div>
            <h1 class="success">Email Verified!</h1>
            <p>Your email has been successfully verified. Check your inbox for a welcome message from Seekive!</p>
            <a href="/" class="btn">
                <i class="fa-solid fa-home"></i>
                Back to Home
            </a>
        </div>

        <!-- Error State -->
        <div id="error" class="message-container">
            <div class="icon error">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <h1 class="error">Verification Failed</h1>
            <p id="errorMessage">The verification link is invalid or has expired. Please try signing up again.</p>
            <a href="/early-access-signup/" class="btn">
                <i class="fa-solid fa-arrow-left"></i>
                Back to Signup
            </a>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDLxbwUIRujt487DXEsKujb-6DC3yIoHAI",
            authDomain: "seekiveprofile.firebaseapp.com",
            projectId: "seekiveprofile",
            storageBucket: "seekiveprofile.firebasestorage.app",
            messagingSenderId: "284191726552",
            appId: "1:284191726552:web:72d26bdc3b2a2056e4b0ad",
            measurementId: "G-G373XT0EGB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Generate welcome email HTML
        function generateWelcomeEmail(firstName) {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Reset styles for email client compatibility */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0F172A;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        table {
            border-collapse: collapse;
            border-spacing: 0;
        }
        
        img {
            border: 0;
            outline: none;
            text-decoration: none;
            display: block;
        }
        
        .email-container {
            max-width: 650px;
            margin: 0 auto;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            border-radius: 24px;
            overflow: hidden;
        }
        
        .email-header {
            background: linear-gradient(135deg, #4C8BF5 0%, #06B6D4 100%);
            padding: 40px 40px 60px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .email-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .logo-section {
            display: table;
            margin: 0 auto 24px auto;
        }
        
        .logo-section-inner {
            display: table-cell;
            vertical-align: middle;
        }
        
        .logo-circle {
            display: inline-block;
            width: 64px;
            height: 64px;
            vertical-align: middle;
            margin-right: 16px;
        }
        
        .logo-circle img {
            width: 64px;
            height: 64px;
            object-fit: contain;
        }
        
        .logo-text {
            display: inline-block;
            vertical-align: middle;
            font-size: 32px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin: 12px 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 2;
            font-weight: 500;
            margin: 0;
        }
        
        .email-content {
            padding: 50px 40px;
            background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
        }
        
        .welcome-message {
            font-size: 18px;
            color: #F8FAFC;
            margin-bottom: 24px;
            font-weight: 600;
            text-align: center;
        }
        
        .content-text {
            font-size: 16px;
            color: #94A3B8;
            line-height: 1.7;
            margin: 0 0 20px 0;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, rgba(76, 139, 245, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border: 1px solid rgba(76, 139, 245, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
            text-align: center;
        }
        
        .highlight-title {
            font-size: 20px;
            font-weight: 700;
            color: #4C8BF5;
            margin-bottom: 12px;
        }
        
        .highlight-text {
            font-size: 15px;
            color: #CBD5E1;
            line-height: 1.6;
            margin-bottom: 12px;
        }
        
        .content-list {
            color: #CBD5E1;
            line-height: 1.8;
            padding-left: 20px;
            margin: 16px 0 0 0;
            text-align: left;
        }
        
        .content-list li {
            margin: 8px 0;
        }
        
        .cta-section {
            text-align: center;
            margin: 40px 0 32px 0;
        }
        
        .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, #4C8BF5, #2563EB);
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            padding: 18px 48px;
            border-radius: 50px;
            box-shadow: 0 8px 24px rgba(76, 139, 245, 0.4);
            mso-line-height-rule: exactly;
        }
        
        .cta-button span {
            color: #FFFFFF !important;
            text-decoration: none;
            display: inline-block;
        }
        
        .email-footer {
            background: #0F172A;
            text-align: center;
            padding: 32px 40px;
            color: #64748B;
            font-size: 14px;
            border-top: 1px solid rgba(76, 139, 245, 0.2);
        }
        
        .social-links {
            margin: 20px 0;
            font-size: 14px;
            color: #64748B;
        }
        
        .social-links a {
            color: #4C8BF5;
            text-decoration: none;
            margin: 0 4px;
        }
        
        .social-links a:hover {
            text-decoration: underline;
        }
        
        .footer-text {
            font-size: 14px;
            color: #64748B;
            margin: 16px 0;
        }
        
        .tagline {
            font-size: 12px;
            color: #475569;
            margin-top: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        /* Mobile responsiveness */
        @media only screen and (max-width: 600px) {
            .email-container {
                border-radius: 0;
                margin: 0;
            }
            
            .email-header,
            .email-content,
            .email-footer {
                padding: 32px 24px !important;
            }
            
            .logo-text {
                font-size: 28px;
            }
            
            .header-title {
                font-size: 24px;
            }
            
            .cta-button {
                padding: 16px 32px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="email-container">
        <!-- Header Section -->
        <div class="email-header">
            <div class="logo-section">
                <div class="logo-section-inner">
                    <div class="logo-circle">
                        <img src="https://www.seekive.com/logo1.png" alt="Seekive Logo">
                    </div>
                    <div class="logo-text">Seekive</div>
                </div>
            </div>
            <h1 class="header-title">Welcome to Early Access!</h1>
            <p class="header-subtitle">You're now part of the Seekive discovery community</p>
        </div>
        
        <!-- Main Content -->
        <div class="email-content">
            <p class="welcome-message">Thank you for joining us!</p>
            
            <p class="content-text">
                Welcome to Seekive Early Access! We're thrilled to have you join our community of explorers and adventure seekers.
            </p>
            
            <p class="content-text">
                As soon as we're ready to launch, you'll be among the very first to know and experience Seekive's intelligent discovery compass that finds experiences perfectly matched to your mood, time, and budget.
            </p>
            
            <div class="highlight-box">
                <h3 class="highlight-title">What Happens Next?</h3>
                <p class="highlight-text">
                    We'll keep you updated on our progress and send you your personal early access invitation as soon as early access opens. In the meantime:
                </p>
            
                <ul class="content-list">
                    <li>Follow us on social media for behind-the-scenes updates</li>
                    <li>Reply to this email with any questions or feedback</li>
                    <li>Tell your friends about Seekive!</li>
                </ul>
            </div>
            
            <div class="cta-section">
                <a href="https://www.seekive.com" class="cta-button"><span>Visit Seekive.com</span></a>
            </div>
            
            <p class="content-text">
                We appreciate your interest and look forward to helping you discover amazing experiences soon.
            </p>
            
            <p class="content-text">
                Thanks for believing in our vision!
            </p>
            
            <p class="content-text" style="margin-bottom: 0;">
                Best regards,<br>
                <strong style="color: #4C8BF5;">Marc & The Seekive Team</strong><br>
                <em style="color: #64748B;">Seek It. Find It. Live It.</em>
            </p>
        </div>
        
        <!-- Footer -->
        <div class="email-footer">
            <div class="social-links">
                <a href="https://www.instagram.com/seekiveapp/">Instagram</a> â€¢
                <a href="https://x.com/seekiveapp">X</a> â€¢
                <a href="https://www.facebook.com/profile.php?id=61575759483549">Facebook</a> â€¢
                <a href="https://www.tiktok.com/@seekiveapp">TikTok</a> â€¢
                <a href="https://www.youtube.com/@seekiveapp">YouTube</a> â€¢
                <a href="https://uk.pinterest.com/seekiveapp/">Pinterest</a>
            </div>
            <p class="footer-text">Follow our journey as we build the future of discovery</p>
            <p class="footer-text">Â© 2025 Seekive. All rights reserved.</p>
            <p class="tagline">SEEK IT. FIND IT. LIVE IT.</p>
        </div>
    </div>
</body>
</html>`;
        }

        // Handle email verification
        async function handleEmailVerification() {
            const urlParams = new URLSearchParams(window.location.search);
            const uid = urlParams.get('uid');
            const token = urlParams.get('token');

            console.log('Verification attempt:', { uid, token }); // Debug log

            if (!uid || !token) {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('error').classList.add('show');
                document.getElementById('errorMessage').textContent = 
                    'Invalid verification link. Please check your email for the correct link.';
                return;
            }

            try {
                // Get user document from Firestore (no auth required)
                const userDoc = await db.collection('earlyAccessUsers').doc(uid).get();

                console.log('User doc exists:', userDoc.exists); // Debug log

                if (!userDoc.exists) {
                    throw new Error('User not found');
                }

                const userData = userDoc.data();
                console.log('User data:', { 
                    hasToken: !!userData.verificationToken, 
                    isVerified: userData.emailVerified 
                }); // Debug log

                // Check if token matches
                if (userData.verificationToken !== token) {
                    console.error('Token mismatch:', { 
                        expected: userData.verificationToken, 
                        received: token 
                    }); // Debug log
                    throw new Error('Invalid token');
                }

                // Check if already verified
                if (userData.emailVerified) {
                    console.log('Already verified'); // Debug log
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('success').classList.add('show');
                    return;
                }

                console.log('Starting verification update...'); // Debug log

                // STEP 1: Mark as verified and DELETE old email fields completely
                await db.collection('earlyAccessUsers').doc(uid).update({
                    emailVerified: true,
                    status: 'verified',
                    verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    verificationToken: firebase.firestore.FieldValue.delete(),
                    to: firebase.firestore.FieldValue.delete(),
                    message: firebase.firestore.FieldValue.delete(),
                    delivery: firebase.firestore.FieldValue.delete()
                });

                console.log('Verification marked, waiting...'); // Debug log

                // STEP 2: Wait for deletion to complete
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('Sending welcome email...'); // Debug log

                // STEP 3: Create FRESH email trigger for welcome email
                await db.collection('earlyAccessUsers').doc(uid).update({
                    to: [userData.email],
                    message: {
                        subject: 'ðŸŽ‰ Welcome to Seekive Early Access!',
                        html: generateWelcomeEmail(userData.firstName)
                    }
                });

                console.log('Success!'); // Debug log

                // Show success message
                document.getElementById('loading').classList.remove('show');
                document.getElementById('success').classList.add('show');

            } catch (error) {
                console.error('Verification error details:', error); // Debug log
                console.error('Error code:', error.code); // Debug log
                console.error('Error message:', error.message); // Debug log
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('error').classList.add('show');
                
                let errorMsg = 'Verification failed. This link may have expired or already been used.';
                
                if (error.message === 'User not found') {
                    errorMsg = 'User account not found. Please try signing up again.';
                } else if (error.message === 'Invalid token') {
                    errorMsg = 'This verification link is invalid or has expired.';
                } else if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied. Please check Firebase rules and try again.';
                } else if (error.code) {
                    errorMsg = `Error (${error.code}): ${error.message}`;
                }
                
                document.getElementById('errorMessage').textContent = errorMsg;
            }
        }

        // Run verification when page loads
        window.addEventListener('load', handleEmailVerification);
    </script>
</body>
</html>

